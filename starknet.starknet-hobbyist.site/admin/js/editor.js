function _editor(e){this.e=$(e),this.id=e,this.obj=$(e)[0],this.obj.spellcheck=!1,this.obj.contentEditable="true",this.sel,this.ran,this.editorBegin()}_editor.prototype={editorBegin:function(){var e=this,t=this.obj;t.focus(),this.setRange(),t.blur(),window.scrollTo(0,0),this.defaultFunc(),this.filter(),t.onclick=function(){e.eventFunc(e)},t.onkeyup=function(){e.eventFunc(e)},t.onkeypress=function(){e.eventFunc(e)},t.ondrop=function(e){(e=e||window.event).preventDefault?e.preventDefault():e.returnValue=!1},t.onpaste=function(){var t=event.clipboardData||window.clipboardData,n=t.items[0],r=n.type,a=new FileReader;if(event.preventDefault&&event.preventDefault(),-1!==r.indexOf("image")){var i=n.getAsFile();return a.readAsDataURL(i),a.onload=function(t){e.u(t.target.result,function(t){parent.layer.msg(t.msg,{icon:t.code});var n='<img src="'+t.data.host+'"/>';e.insertHTML(n)})},parent.layer.msg("粘贴了图片"),e.formatText(),!0}var o=t.getData("text");return e.insertHTML(o),parent.layer.msg("粘贴了文字"),e.formatText(),!1}},formatText:function(){this.e.find("*").not(".emoji").removeAttr("style")},eventFunc:function(e){var t=e,n=e.obj,r=n.textContent,a=n.innerHTML,i=r.length,o=a.length;if(0==i&&0!=o)if(4==o){var s=n.getElementsByTagName("br");t.removeElement(s[s.length-1])}else if(11==o||13==o){var l=n.getElementsByTagName("p");t.removeElement(l[l.length-1])}else if(15==o){var c=n.getElementsByTagName("div");t.removeElement(c[c.length-1])}(document.activeElement.id=t.id)&&t.setRange()},insertHTML:function(e){null==this.ran&&(this.obj.focus(),this.setRange());var t=this.ran.createContextualFragment(e),n=t.lastChild;this.ran.deleteContents(),this.ran.insertNode(t),this.ran.setStartAfter(n),this.sel.removeAllRanges(),this.sel.addRange(this.ran),this.obj.focus()},insertEmoji:function(e){if(null==e.src)return console.error("insert emoji src is not define"),!1;e.remark||(e.remark="");var t='<img src="'+e.src+'" easy-remark="'+e.remark+'" />';return this.insertHTML(t),e.afterInsert&&e.afterInsert.call(this),this},insertBlock:function(e){this.insertHTML('<br id="changeLinear"/><span id="editorSaveWidth">'+e.text+"</span>");var t=document.getElementById("editorSaveWidth"),n=this.getRect(t).width;this.removeElement(t),this.removeElement(document.getElementById("changeLinear")),e.color=null==e.color?"":"color:"+e.color+";";var r='<input type="text" disabled="disabled" value="'+e.text+'" style="width:'+n+"px;"+e.color+'">';return this.insertHTML(r),e.afterInsert&&e.afterInsert.call(this),this},getContent:function(e){var t=this.obj.innerHTML;if("function"==typeof e)e=!1;var n=this.obj.innerHTML;if(e){for(var r=this.obj.getElementsByTagName("input"),a=0;a<r.length;a++){(o=document.createElement("span")).innerHTML="|"+r[a].getAttribute("value")+"|",r[a].parentNode.insertBefore(o,r[a])}var i=this.obj.getElementsByTagName("img");for(a=0;a<i.length;a++){var o;(o=document.createElement("span")).innerHTML="|"+i[a].getAttribute("easy-remark")+"|",i[a].parentNode.insertBefore(o,i[a])}n=this.obj.innerHTML}return this.obj.innerHTML=t,n},editorHolder:function(e){return this.obj.placeholder=e,this},getRange:function(e){if(!e){if(!this.ran)return;e=this.ran}if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else document.selection&&e.select()},setRange:function(){if(this.sel=this.createRange(),null==this.sel)return!1;window.getSelection?this.ran=this.sel.getRangeAt(0):this.ran=this.sel.createRange()},createRange:function(){if(window.getSelection){if((e=window.getSelection()).rangeCount>0)return e}else if(document.selection){var e;return(e=document.selection).createRange()}return null},filter:function(){try{document.execCommand("AutoUrlDetect",!1,!1)}catch(e){}this.obj.onpaste=function(e){(e=e||window.event).preventDefault?e.preventDefault():e.returnValue=!1;var t=null;if(t=window.clipboardData&&clipboardData.setData?window.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain"),document.body.createTextRange){if(document.selection)textRange=document.selection.createRange();else if(window.getSelection){sel=window.getSelection();var n=sel.getRangeAt(0),r=document.createElement("span");r.innerHTML="&#FEFF;",n.deleteContents(),n.insertNode(r),textRange=document.body.createTextRange(),textRange.moveToElementText(r),r.parentNode.removeChild(r)}textRange.text=t,textRange.collapse(!1),textRange.select()}else document.execCommand("insertText",!1,t)}},defaultFunc:function(){"undefined"==typeof Range||Range.prototype.createContextualFragment||(Range.prototype.createContextualFragment=function(e){var t=document.createDocumentFragment(),n=document.createElement("div");return t.appendChild(n),n.outerHTML=e,t})},removeElement:function(e){var t=e.parentNode;t&&t.removeChild(e)},getRect:function(e){var t=e.getBoundingClientRect(),n=document.documentElement.clientLeft,r=document.documentElement.clientTop;return{left:t.left-n,top:t.top-r,right:t.right-n,bottom:t.bottom-r,width:t.right-t.left,height:t.bottom-t.top}},u:function(e,t){var n=new FormData,r=this.B(e,"u.png");n.append("file",r),n.append("path","./admin/upload/chat/"),$.ajax({url:api.url("upload","../?method="),type:"POST",dataType:"json",data:n,processData:!1,contentType:!1,beforeSend:function(){parent.layer.msg('<span class="layer-load">正在上传</span>',{icon:16,shade:.05,time:!1})},xhr:function(){var e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t=(e.loaded/e.total*100).toFixed(2)+"%";$(".layer-load").text("已上传"+t)}),e},success:function(e){t&&t(e)},error:e=>layer.alert(e.responseText,{icon:2})})},B:function(e,t){for(var n=e.split(","),r=n[0].match(/:(.*?);/)[1],a=atob(n[1]),i=a.length,o=new ArrayBuffer(i),s=new Uint8Array(o);i--;)s[i]=a.charCodeAt(i);return new File([s],t,{type:r})}};